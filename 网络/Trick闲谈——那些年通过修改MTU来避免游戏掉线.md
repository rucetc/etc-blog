最近跟朋友闲聊的时候谈到一个关于MTU的trick——通过修改MTU值来避免掉线以及降低延迟。我记得最早是在猴岛游戏论坛看到这个tirck：WOW70年代法师带血色刷G释放暴风雪技能时可能导致游戏掉线，调低系统MTU值可以避免掉线。后来也有人用这个方法来避免其他游戏掉线或降低延迟。现在就简单分析一下其中的原理，顺便复习一下计算机网络：



#### 链路层

先从链路层开始分析：

##### 帧长度

首先，二层以太网和802.3都采用CSMA/CD媒体接入的方法，最小帧长是64字节，最大帧长1518字节，其中这个最小帧长度是根据CSMA/CD的特性决定的，CSMA/CD中每个站点在发送数据之前，都会侦听一个时隙。这个时隙为2倍的信道上两个距离最远的站点之间信号传输所需要的时间，这样就能够保证信道上出现冲突一定可以监测得到。以10Mb/s乘以时隙得到能够保证监测到冲突的帧的**最小帧长**即64字节，本质上由网络媒介的**物理特性决定的**。至于**最大帧长**1518字节是一个**逻辑限制**，很明显它跟传输吞吐量以及站点的平均等待时间相关。

##### MTU

最大传输单元，即**链路层能够承载上层协议数据的最大值**。以太网（RFC 894）的MTU是1500 = 1518 - 14（帧首部）- 4（校验码）；802.3（RFC 1042）的MTU是1492 = 1518 - 22（帧首部） - 4（校验码）。很明显由于802.3的帧首部长度比以太网长8字节，故其MTU要比以太网少8个字节。以太网是事实标准，它兼容802.3。不同类型的网络MTU值是不一样的，比如802.5令牌环的MTU值是4464。

##### PPPoE

PPP over Ethernet 基于以太网的点对点协议，是使用ADSL上网的用户上网时使用的链路层附属协议，这样就导致链路层所承载数据的最大传输值小于1500字节。



#### 网络层

##### 分片和垫片

对于IP数据报的长度由其首部的16为总长度字段决定，故最大值为65535。IP数据报是IP层端到端的传输单元，IP分组是IP层和链路层之间传输的单元，由于链路层有MTU限制，故要对**超过MTU限制的IP数据报进行分片**；对于**不足链路层传输最小帧长的IP数据报要做垫片**处理。

**当IP数据报被分片后，每一片都成为一个分组，具有自己的IP首部，并在选择路由时与其他分组独立**。这样，当数据报的这些片**到达目的端时有可能会失序**，但是在IP首部中有足够的信息让接收端能正确组装这些数据报片。**即使只丢失一片数据也要重传整个数据报**。

注意，分片操作仅在出接口的时候判断，IP分片的组装仅在目的地进行。

由于分片可能出现在中间路由器上，信源对此并不知情，故当分片丢失的时候告诉信源重发某个特定的分片是不可能的。

另外，**在第一个数据报片出现时，IP层必须启动一个定时器**。如果定时器超时而该数据报的所有**数据报片未能全部到达，那么将这些数据报片丢弃**。如果不这么做，那些永远不会到达的数据报片迟早会引起接收端缓存满。

综上，在IP上层协议设计时要**避免在IP层出现分片**。

##### ICMP

###### 需要分片但又设置DF的ICMP不可达错误

需要分片但又设置DF的ICMP不可达错误，利用它可以得到路径MTU值。**路径MTU**是源到目的所经过路由MTU的最小值。路径MTU发现程序原理类似于traceroute，这个ICMP差错报文会返回出接口的MTU值供路径MTU发现程序参考。

###### 源站抑制差错

接收数据报的速度比其处理速度快时，可能产生这个差错。由于源站抑制要消耗网络带宽，且对于拥塞来说可能导致网络状况更糟糕。



#### 传输层

##### UDP

一个UDP数据报对应一个IP数据报。如果不在UDP上层对UDP数据报的大小做控制。那么UDP数据报很有可能会产生分片。

##### TCP

TCP面向字节流，没有边界信息，IP数据报中可能会出现“粘包”、“半包”。TCP之所以这么做的原因之一是为了尽量避免分片。当建立一个TCP连接的时候，通信双方会通告彼此各自的**MSS**。MSS是最大报文长度，类似MTU，MSS值越大它的吞吐量就越高，所以MSS值尽可能要设置很大。理论上，对于一个以太网，在不做IP分片的情况下，MSS的最大值为1460 = MTU1500 - IP首部20 - TCP首部20。实际在TCP连接建立时，MSS的大小也是通过出接口的MTU减协议首部长度进行估算。当然，也可以利用路径MTU发现机制来确定MSS的大小。



#### 应用层

尽管游戏、实时音视频传输很适合使用UDP协议，但魔兽世界等游戏用的是TCP协议。



#### 总结

到了这里不难明白：在以太网中，魔兽世界客户端和服务器在TCP连接建立阶段按以太网默认MTU值1500计算的通告MSS值1460；但是由于使用ADSL上网，接入ISP二层附属PPPoE协议，实际一个以太网帧能承载的TCP数据要小于1460，故而会在出接口的时候对封装TCP数据的IP数据报分片，分成两个IP分组，更糟糕的是其中一个IP分组还使用了垫片。在释放AOE技能的时候，传输数据突然增加，丢失分片的可能性增大，由于TCP是可靠的传输协议，会重传丢失的整个IP数据报；此外，在向外发送数据的过程中，还很可能产生源站抑制差错报文，TCP会对源站抑制差错报文做出响应，降低客户端的传输速度，最终导致游戏延迟飙升或者游戏掉线。